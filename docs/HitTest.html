---

title: Title

keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/05_HitTest.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_HitTest.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>51.6¬∫, 179.2¬∫, 38068.6km
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="HitTest">HitTest<a class="anchor-link" href="#HitTest"> </a></h2><blockquote><p>VAULT Proposal python module for addressing Technical Scenario objective 1</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Objective 1:</p>
<blockquote><p>1) Determine the ‚Äúhits‚Äù where a satellite has geodetic overlap of any vessel(s) at any point(s) in time. For simplicity, it may be assumed that a satellite has full view of half the earth (regardless of satellite type or its elevation above the earth). However, additional accuracy models with rationale is allowed.</p>
</blockquote>
<p>A satellite can see the ship only if the ship can see the satellite. So instead of the half-earth assumption, we define a "hit" as the satellite being above the horizon (defined as "alt" ‚â•0¬∫ in a ship-based alt-azimuth coordinate system).</p>
<p>According to <a href="http://www.marinetraffic.org/exactearth/">exactEarth</a>, a more realistic approximation is that AIS satellites at 650 km have a 5000 km diameter Field of View. That corresponds to a horizon of about ùúÉ=14.6¬∫, as shown here:
                             üõ∞
                             : <code>:</code>
                         650 :         <code>km :</code>
                             :                 <code>:    2500km        ùúÉ</code>
                             .........................`üõ≥</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="n">ùúÉ</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mi">650</span><span class="o">/</span><span class="mi">2500</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ùúÉ</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>14.6
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-Schema-and-Path">Define Schema and Path<a class="anchor-link" href="#Define-Schema-and-Path"> </a></h3><p>Save memory by using appropriate data types for the TLE elements. (Determined by peeking at the data file or reading the TLE format.) This saves quite a bit, and may save more as Pandas optimizes the <code>string</code> class vs. default <code>object</code>. Regardless, it makes columns single-typed.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Quality-Values">Quality Values<a class="anchor-link" href="#Quality-Values"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_qvals</span><span class="p">(</span><span class="n">delta_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">13.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get quality vals for &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">delta_days</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt</span><span class="o">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">QUALITY_EXCELLENT</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">QUALITY_EXCELLENT</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">delta_days</span> <span class="o">&lt;=</span> <span class="mf">14.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt</span><span class="o">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">QUALITY_GOOD</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">QUALITY_GOOD</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">delta_days</span> <span class="o">&lt;=</span> <span class="mf">56.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt</span><span class="o">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">QUALITY_POOR</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">QUALITY_POOR</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">QUALITY_STALE</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">alt</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span> <span class="n">delta_days</span><span class="p">]</span> <span class="o">+</span> <span class="n">qvals</span><span class="p">)</span>

<span class="c1">#</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="HitTest-Class">HitTest Class<a class="anchor-link" href="#HitTest-Class"> </a></h3><p>During data posturing we created single-day TLE files, so each day contains the most recent TLE for all 12K satellites.</p>
<p>The <a href="/jacobs-vault/HitTest#HitTest"><code>HitTest</code></a> constructor takes a date, loads the TLE dayfile, and returns the corresponding DataFrame.</p>
<p><em>TODO</em>: Most of these satellites are useless. Speed by ignoring.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="HitTest" class="doc_header"><code>class</code> <code>HitTest</code><a href="https://github.com/cmorris-jacobs/jacobs-vault/tree/main/jacobs_vault/hit_test.py#L49" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>HitTest</code>(<strong><code>dt</code></strong>, <strong><code>day_file_base_path</code></strong>=<em><code>'../data/VAULT_Data/TLE_daily'</code></em>)</p>
</blockquote>
<p>Counts the satellites that are visible at a given point on the globe at a
given time, and returns counts classified by data quality and
latitude, azimuth, hit_quality, radius for visible satellites</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then test it on a single day.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ht</span> <span class="o">=</span> <span class="n">HitTest</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
<span class="n">ht</span><span class="o">.</span><span class="n">df_day_tle</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2016-06-30 00:00:00	data/VAULT_Data/TLE_daily/2016/06/30.tab.gz
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>satellite</th>
      <th>day_dt</th>
      <th>day</th>
      <th>tle_dt</th>
      <th>tle_ts</th>
      <th>line1</th>
      <th>line2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1000</td>
      <td>2016-06-30</td>
      <td>6026</td>
      <td>2016-06-27 11:15:21</td>
      <td>1467040521</td>
      <td>1 01000U 65008B   16179.46899882  .00000021  0...</td>
      <td>2 01000  32.1467 333.7511 0009366 165.3909 194...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1000</td>
      <td>2016-06-30</td>
      <td>6026</td>
      <td>2016-06-27 11:15:21</td>
      <td>1467040521</td>
      <td>1 01000U 65008B   16179.46899882  .00000021  0...</td>
      <td>2 01000  32.1467 333.7511 0009366 165.3909 194...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1000</td>
      <td>2016-06-30</td>
      <td>6026</td>
      <td>2016-06-27 11:15:21</td>
      <td>1467040521</td>
      <td>1 01000U 65008B   16179.46899882  .00000021  0...</td>
      <td>2 01000  32.1467 333.7511 0009366 165.3909 194...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>2016-06-30</td>
      <td>6026</td>
      <td>2016-06-30 10:49:53</td>
      <td>1467298193</td>
      <td>1 10000U 77034A   16182.45131225 -.00000171  0...</td>
      <td>2 10000  15.5820 331.7785 0019081 259.0540  28...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10002</td>
      <td>2016-06-30</td>
      <td>6026</td>
      <td>2016-06-28 23:10:32</td>
      <td>1467169832</td>
      <td>1 10002U 77034C   16180.96565494 -.00000126  0...</td>
      <td>2 10002  16.1681 333.0471 0296361   5.9346   0...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">satellite</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>29201    106
39694    101
33472     94
28584     87
29203     81
        ... 
333        1
18764      1
29003      1
34004      1
16384      1
Name: satellite, Length: 12152, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Memory-check">Memory check<a class="anchor-link" href="#Memory-check"> </a></h3><p>Inspect the resulting dtypes and memory usage.</p>
<p>The parsing was successful. As expected, <code>line1</code> and <code>line2</code> are large. Using <code>category</code> doesn't save much because so many rows are unique.  The <code>datetime</code> categories are surprisingly large.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Dtype&#39;</span><span class="p">,</span> <span class="s1">&#39;Mem&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Dtype</th>
      <th>Mem</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>satellite</th>
      <td>uint16</td>
      <td>24304</td>
    </tr>
    <tr>
      <th>day_dt</th>
      <td>datetime64[ns]</td>
      <td>97216</td>
    </tr>
    <tr>
      <th>day</th>
      <td>uint16</td>
      <td>24304</td>
    </tr>
    <tr>
      <th>tle_dt</th>
      <td>datetime64[ns]</td>
      <td>97216</td>
    </tr>
    <tr>
      <th>tle_ts</th>
      <td>uint32</td>
      <td>48608</td>
    </tr>
    <tr>
      <th>line1</th>
      <td>string</td>
      <td>1531152</td>
    </tr>
    <tr>
      <th>line2</th>
      <td>string</td>
      <td>1531152</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 12152 entries, 0 to 15178
Data columns (total 7 columns):
 #   Column     Non-Null Count  Dtype         
---  ------     --------------  -----         
 0   satellite  12152 non-null  uint16        
 1   day_dt     12152 non-null  datetime64[ns]
 2   day        12152 non-null  uint16        
 3   tle_dt     12152 non-null  datetime64[ns]
 4   tle_ts     12152 non-null  uint32        
 5   line1      12152 non-null  string        
 6   line2      12152 non-null  string        
dtypes: datetime64[ns](2), string(2), uint16(2), uint32(1)
memory usage: 569.6 KB
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;line1&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s2">&quot;line2&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1 01001U 65008A   16178.87975142  .00000008  00000-0  00000+0 0  2425
2 01001  32.1427 144.4001 0016649 349.5981  10.4171  9.90724672860590
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Skyfield">Skyfield<a class="anchor-link" href="#Skyfield"> </a></h3><p>First, test the basic operation works as expected.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>51.6¬∫, 179.2¬∫, 38068.6km
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="test_skyfield" class="doc_header"><code>test_skyfield</code><a href="https://github.com/cmorris-jacobs/jacobs-vault/tree/main/jacobs_vault/hit_test.py#L162" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>test_skyfield</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1971</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">==</span> <span class="mi">365</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="mf">51.5</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span><span class="s1">&#39;az&#39;</span><span class="p">,</span><span class="s1">&#39;days&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alt</th>
      <td>51.5</td>
    </tr>
    <tr>
      <th>az</th>
      <td>189.0</td>
    </tr>
    <tr>
      <th>days</th>
      <td>2.3</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Can-they-see-me?">Can they see me?<a class="anchor-link" href="#Can-they-see-me?"> </a></h3><p>Given at Lat/Lon/Time, what satellites can see me?</p>
<p>We pre-partition the TLE data by Year/Month/Day, so we can quickly load only <em>today's</em> TLE data, and check whether Lat/Lon can see it.</p>
<h4 id="First-step:-get-Alt/Az/dt-for-each-row.">First step: get Alt/Az/dt for each row.<a class="anchor-link" href="#First-step:-get-Alt/Az/dt-for-each-row."> </a></h4><p>Here we <code>apply</code> the <code>Skyfield.EarthSatellite</code> function to all TLE rows in the dataframe for today.</p>
<p><strong>Benchmark</strong>: this takes about 6s on a laptop. @TODO: speed this up by 10x.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong> Minor glitch: cannot use faster <code>raw=True</code></strong></p>
<p>In theory <code>apply(..., raw=True)</code> should be faster than default <code>apply</code>.  However, it's not working due to:</p>
<blockquote><p>AssertionError:Number of manager items must equal union of block items&gt; # manager items:7, # tot_items:</p>
<ul>
<li>Possible solution: <code>https://www.nuomiphp.com/eplan/en/254300.html</code></li>
<li>On the other hand, it's an open pandas ticket: <code>https://github.com/pandas-dev/pandas/issues/34822</code></li>
</ul>
</blockquote>
<p>So I <code>try</code> the default way first. But the <code>except</code> won't work until we track down the block manager issue.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Execute-for-a-given-day">Execute for a given day<a class="anchor-link" href="#Execute-for-a-given-day"> </a></h3><p>2016-06-30 for starters</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days</span> <span class="o">=</span> <span class="n">satellite_alt_az_days</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="mf">45.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">176.0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2016-06-30 00:00:00	data/VAULT_Data/TLE_daily/2016/06/30.tab.gz
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>altitude    12152
azimuth     12152
days        12152
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>altitude</th>
      <th>azimuth</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-42.413819</td>
      <td>297.656662</td>
      <td>2 days 12:44:39</td>
    </tr>
    <tr>
      <th>3</th>
      <td>51.646300</td>
      <td>179.205373</td>
      <td>0 days 10:49:53</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-32.583116</td>
      <td>299.096010</td>
      <td>1 days 00:49:28</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-10.852721</td>
      <td>159.700750</td>
      <td>3 days 02:53:10</td>
    </tr>
    <tr>
      <th>10</th>
      <td>-28.903495</td>
      <td>101.253621</td>
      <td>0 days 04:49:32</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Second-step:-Calculate-the-hit-quality">Second step: Calculate the hit quality<a class="anchor-link" href="#Second-step:-Calculate-the-hit-quality"> </a></h4><p>First approximation:</p>
<ul>
<li>It's a <strong>hit</strong> if the alt &gt; 0 (above the horizon).</li>
<li>Smaller TLE age -&gt; better quality (less stale)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="hit_quality" class="doc_header"><code>hit_quality</code><a href="https://github.com/cmorris-jacobs/jacobs-vault/tree/main/jacobs_vault/hit_test.py#L188" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>hit_quality</code>(<strong><code>df_alt_az_days</code></strong>, <strong><code>MISS</code></strong>=<em><code>0</code></em>, <strong><code>EXC</code></strong>=<em><code>2.0</code></em>, <strong><code>GOOD</code></strong>=<em><code>14.0</code></em>, <strong><code>POOR</code></strong>=<em><code>56.0</code></em>)</p>
</blockquote>
<p>Return hit/miss and quality as time proximity.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p><code>df_alt_az_days</code>: Dataframe returned by <a href="/jacobs-vault/Early_HitTest#satellite_alt_az_days"><code>satellite_alt_az_days</code></a>.
<code>MISS</code>: Alt. &lt; MISS is a miss. (Default=0, the horizon)
<code>EXC</code>: TLE age less than this is 'excellent' (Default 2)
<code>GOOD</code>: TLE age less than this is 'good' (Default 14)
<code>POOR</code>: TLE age less than this is 'poor' (Default 56)
        Anything older is 'stale'.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>Dataframe with columns ["hit", "miss"]. Each row will have exactly one filled, with
a string denoting how recent the pass was, e.g. "excellent", "good", "poor", "stale".</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_hit_quality</span> <span class="o">=</span> <span class="n">hit_quality</span><span class="p">(</span><span class="n">df_alt_az_days</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_hit_quality</span><span class="p">[</span><span class="s2">&quot;hit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>excellent    1490
good           30
poor            1
Name: hit, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_hit_quality</span><span class="p">[</span><span class="s2">&quot;miss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>excellent    10439
good           178
poor             9
stale            5
Name: miss, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_hit_quality</span><span class="p">[</span><span class="s2">&quot;hit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> <span class="n">df_hit_quality</span><span class="p">[</span><span class="s2">&quot;miss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hit</th>
      <th>miss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>excellent</th>
      <td>1490.0</td>
      <td>10439</td>
    </tr>
    <tr>
      <th>good</th>
      <td>30.0</td>
      <td>178</td>
    </tr>
    <tr>
      <th>poor</th>
      <td>1.0</td>
      <td>9</td>
    </tr>
    <tr>
      <th>stale</th>
      <td>NaN</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days_visible</span> <span class="o">=</span> <span class="n">df_alt_az_days</span><span class="p">[</span><span class="n">df_alt_az_days</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days_visible</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>altitude    1521
azimuth     1521
days        1521
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_alt_az_days_visible</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>altitude</th>
      <th>azimuth</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>51.646300</td>
      <td>179.205373</td>
      <td>0 days 10:49:53</td>
    </tr>
    <tr>
      <th>17</th>
      <td>48.571486</td>
      <td>219.021839</td>
      <td>0 days 17:13:44</td>
    </tr>
    <tr>
      <th>21</th>
      <td>35.295619</td>
      <td>324.390831</td>
      <td>0 days 12:34:30</td>
    </tr>
    <tr>
      <th>22</th>
      <td>67.176418</td>
      <td>358.140393</td>
      <td>1 days 15:57:40</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2.153692</td>
      <td>266.529239</td>
      <td>0 days 09:03:34</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Visualize-the-results">Visualize the results<a class="anchor-link" href="#Visualize-the-results"> </a></h2><p>Generate a polar alt/az plot of the qualifying satellites</p>
<ul>
<li>Excellent = blue</li>
<li>Good = red</li>
<li>Else = yellow</li>
</ul>
<p><strong>TODO:</strong> Is "0" here 0 altitude? That would be on the horizon, which is counter-intuitive.</p>
<p>Note the band of satellites at southern bearings -- this ship was in the Northern hemisphere.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="colorize" class="doc_header"><code>colorize</code><a href="https://github.com/cmorris-jacobs/jacobs-vault/tree/main/jacobs_vault/hit_test.py#L250" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>colorize</code>(<strong><code>df</code></strong>)</p>
</blockquote>
<p>Replace quality strings with color numbers.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">QUALITY_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>excellent 0
good 1
poor 2
stale 3
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="viz" class="doc_header"><code>viz</code><a href="https://github.com/cmorris-jacobs/jacobs-vault/tree/main/jacobs_vault/hit_test.py#L257" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>viz</code>(<strong><code>df</code></strong>, <strong><code>show</code></strong>=<em><code>True</code></em>, <strong><code>size0</code></strong>=<em><code>1</code></em>)</p>
</blockquote>
<p>Polar plots a <code>df_alt_az_days_visible</code> dataframe.
Dataframe must have: <code>color</code>, <code>days</code>, <code>altitude</code>, <code>azimuth</code>.
Returns a Plotly Express polar plot figure.
If show=True, also displays it here.
size0 is the smallest marker size (used for best hits)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">viz</span><span class="p">(</span><span class="n">df_alt_az_days_visible</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-7-fad8479d6ad4&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>fig <span class="ansi-blue-fg">=</span> viz<span class="ansi-blue-fg">(</span>df_alt_az_days_visible<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;viz&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="David-says-try-these-from-2017:">David says try these from 2017:<a class="anchor-link" href="#David-says-try-these-from-2017:"> </a></h3><ul>
<li>4-jan-2017, 8pm</li>
<li>6 jan 3am</li>
<li>8 jan 6pm</li>
<li>12 jan 5am</li>
<li>19 jan 9am</li>
<li>26 jan 6pm</li>
<li>29 jan 6pm</li>
</ul>

</div>
</div>
</div>
</div>
 

